<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        .option-button.already-have {
            background-color: #4CAF50; /* Green */
        }

            .option-button.already-have:hover {
                background-color: #388E3C; /* Darker Green */
            }

        /* Add these styles inside your <style> tag */
        .bioageform {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

            .bioageform label {
                display: block;
                margin-top: 1rem;
                font-weight: bold;
                color: #333;
            }

            .bioageform input,
            .bioageform select {
                width: 100%;
                padding: 0.5rem;
                margin-top: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

        .input-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }

            .input-group input {
                flex: 1;
            }

            .input-group select {
                margin-left: 0.5rem;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: auto;
            }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .bioageform {
                padding: 1rem;
            }

            .calculate-button {
                font-size: 1rem;
            }
        }

        /* Fieldset Styles */
        .bioageform fieldset {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-top: 2rem;
            border-radius: 8px;
        }

        .bioageform legend {
            font-weight: bold;
            padding: 0 0.5rem;
        }

        /* Visually Hidden Class for Accessibility */
        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px, 1px, 1px, 1px);
            white-space: nowrap;
        }

        /* Error Highlighting */
        .errorNaN {
            border: 2px solid red;
        }

        .privacy-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2>Your Chronological vs Biological Age🧬</h2>
        <p>Calculate your biological age, known as <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5940111/pdf/aging-10-101414.pdf" target="_blank">PhenoAge</a>:</p>
        <form id="phenoAgeForm" class="bioageform">
            <!-- Date of Birth Fields -->
            <fieldset>
                <legend>Date of Birth:</legend>
                <label for="dob-year">Year <span style="font-weight: normal;">(required)</span></label>
                <select id="dob-year" name="dob-year" required aria-required="true" onchange="calculateResult()">
                    <option value="" disabled selected>Select Year</option>
                    <!-- Generate year options dynamically here -->
                </select>

                <label for="dob-month">Month <span style="font-weight: normal;">(optional)</span></label>
                <select id="dob-month" name="dob-month" onchange="calculateResult()">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12" selected>December</option>
                </select>

                <label for="dob-day">Day <span style="font-weight: normal;">(optional)</span></label>
                <select id="dob-day" name="dob-day" onchange="calculateResult()">
                    <option value="" disabled selected>Select Day</option>
                </select>

                <p class="privacy-note">Your privacy matters. Consider leaving your birthday at December 31 at the cost of making you appear younger and giving you a slight disadvantage in the competition.</p>
            </fieldset>

            <!-- Biomarker Fieldset -->
            <fieldset>
                <legend>Biomarkers:</legend>

                <!-- Albumin -->
                <label for="albumin">Albumin</label>
                <div class="input-group">
                    <input type="number" id="albumin" name="albumin" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="albuminUnit" class="visually-hidden">Select unit for Albumin</label>
                    <select id="albuminUnit" name="albuminUnit" aria-label="Albumin unit" oninput="calculateResult()">
                        <option value="1">g/L</option>
                        <option value="0.1">g/dL</option>
                        <option value="0.1">g%</option>
                        <!-- lbumin's molar mass can vary slightly depending on its source and exact composition, usually given as approximately 66,500 g/mol but sometimes noted as 66,430 g/mol or 66,563 g/mol in specific contexts. If we calculate using 66,430 g/mol as the molar mass, then it's: 15.0466µmol/L-->
                        <option value="15.0466">µmol/L</option>
                    </select>
                </div>

                <!-- Creatinine -->
                <label for="creatinine">Creatinine</label>
                <div class="input-group">
                    <input type="number" id="creatinine" name="creatinine" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="creatinineUnit" class="visually-hidden">Select unit for Creatinine</label>
                    <select id="creatinineUnit" name="creatinineUnit" aria-label="Creatinine unit" oninput="calculateResult()">
                        <option value="1">µmol/L</option>
                        <option value="0.0113">mg/dL</option>
                    </select>
                </div>

                <!-- Glucose -->
                <label for="glucose">Glucose</label>
                <div class="input-group">
                    <input type="number" id="glucose" name="glucose" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="glucoseUnit" class="visually-hidden">Select unit for Glucose</label>
                    <select id="glucoseUnit" name="glucoseUnit" aria-label="Glucose unit" oninput="calculateResult()">
                        <option value="1">mmol/L</option>
                        <option value="0.0555">mg/dL</option>
                    </select>
                </div>

                <!-- C-Reactive Protein -->
                <label for="crp">C-Reactive Protein</label>
                <div class="input-group">
                    <input type="number" id="crp" name="crp" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="crpUnit" class="visually-hidden">Select unit for C-Reactive Protein</label>
                    <select id="crpUnit" name="crpUnit" aria-label="CRP unit" oninput="calculateResult()">
                        <option value="10">mg/L</option>
                        <option value="1">mg/dL</option>
                        <option value="95.2381">nmol/L</option>
                    </select>
                </div>

                <!-- Lymphocyte Percentage -->
                <label for="lymphocyte">Lymphocytes</label>
                <div class="input-group">
                    <input type="number" id="lymphocyte" name="lymphocyte" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="lymphocyteUnit" class="visually-hidden">Select unit for Lymphocytes</label>
                    <select id="lymphocyteUnit" name="lymphocyteUnit" aria-label="Lymphocyte unit" oninput="calculateResult()">
                        <option value="1">%</option>
                        <option value="1">1000 cells/μL</option>
                        <option value="1">10⁹ cells/L</option>
                    </select>
                </div>

                <!-- Mean Corpuscular Volume -->
                <label for="mcv">Mean Corpuscular Volume</label>
                <div class="input-group">
                    <input type="number" id="mcv" name="mcv" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="mcvUnit" class="visually-hidden">Select unit for MCV</label>
                    <select id="mcvUnit" name="mcvUnit" aria-label="MCV unit" oninput="calculateResult()">
                        <option value="1">fL</option>
                    </select>
                </div>

                <!-- Red Cell Distribution Width -->
                <label for="rcdw">Red Cell Distribution Width</label>
                <div class="input-group">
                    <input type="number" id="rcdw" name="rcdw" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="rcdwUnit" class="visually-hidden">Select unit for RDW</label>
                    <select id="rcdwUnit" name="rcdwUnit" aria-label="RDW unit" oninput="calculateResult()">
                        <option value="1">%</option>
                    </select>
                </div>

                <!-- Alkaline Phosphatase -->
                <label for="ap">Alkaline Phosphatase</label>
                <div class="input-group">
                    <input type="number" id="ap" name="ap" required aria-required="true" oninput="calculateResult()">
                    <label for="apUnit" class="visually-hidden">Select unit for Alkaline Phosphatase</label>
                    <select id="apUnit" name="apUnit" aria-label="ALP unit" oninput="calculateResult()">
                        <option value="1">U/L</option>
                    </select>
                </div>

                <!-- White Blood Cell Count -->
                <label for="wbc">White Blood Cell Count</label>
                <div class="input-group">
                    <input type="number" id="wbc" name="wbc" step="0.1" required aria-required="true" oninput="calculateResult()">
                    <label for="wbcUnit" class="visually-hidden">Select unit for White Blood Cell Count</label>
                    <select id="wbcUnit" name="wbcUnit" aria-label="WBC unit" oninput="calculateResult()">
                        <option value="1">1000 cells/μL</option>
                        <option value="1">10⁹ cells/L</option>
                    </select>
                </div>
            </fieldset>

            <!-- Calculate Button -->
            <button type="submit" class="option-button calculate-button" aria-label="Calculate your biological age">Calculate My Biological Age</button>
        </form>

        <div id="phenoAgeResult" class="bioageform"></div>

        <div class="options-container">
            <button id="continueButton" class="option-button already-have" onclick="window.location.href='onboarding/convergence.html'" style="display: none;">Next</button>
            <button class="option-button back-button" onclick="window.location.href='/'">Go Back to Homepage</button>
        </div>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script src="/js/pheno-age.js"></script> <!-- Link to your external script -->
    <script>
        updateMainProgress(2);

        document.getElementById('phenoAgeForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the form from submitting and reloading the page
            calculateResult(); // Call the function to calculate the result
        });

        var text_placeholder = 'Enter a number';

        // Biomarker test details and coefficients
        const biomarkers = [
            { id: 'age', name: 'Age', coeff: 0.0804 },
            { id: 'albumin', name: 'Albumin', coeff: -0.0336 },
            { id: 'creatinine', name: 'Creatinine', coeff: 0.0095 },
            { id: 'glucose', name: 'Glucose', coeff: 0.1953 },
            { id: 'crp', name: 'C-reactive protein', coeff: 0.0954 },
            { id: 'wbc', name: 'White blood cell count', coeff: 0.0554 },
            { id: 'lymphocyte', name: 'Lymphocytes', coeff: -0.012 },
            { id: 'mcv', name: 'Mean corpuscular volume', coeff: 0.0268 },
            { id: 'rcdw', name: 'Red cell distribution width', coeff: 0.3306 },
            { id: 'ap', name: 'Alkaline phosphatase', coeff: 0.0019 }
        ];

        // Event listener for form submission
        document.getElementById('phenoAgeForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission
            calculateResult(); // Calculate the result
        });

        function calculateResult() {
            const coefficients = biomarkers.map(marker => marker.coeff);
            const markerValues = [];

            // Get age from separate Date of Birth inputs
            const yearInput = document.getElementById('dob-year').value;
            const monthInput = document.getElementById('dob-month').value;
            const dayInput = document.getElementById('dob-day').value;

            const year = yearInput ? parseInt(yearInput) : null;
            const month = monthInput ? parseInt(monthInput) - 1 : 11; // Convert to 0-based index
            const day = dayInput ? parseInt(dayInput) : 31; // Default to last day

            if (!year) {
                alert("Please select a valid year.");
                return;
            }

            const dobValue = new Date(year, month, day);
            const chronologicalAge = calculateAgeFromDOB(dobValue);

            if (chronologicalAge < 0) {
                alert("Date of birth cannot be in the future.");
                return;
            }

            // Add age as the first marker value
            markerValues.push(chronologicalAge);

            // Get biomarker values
            for (let i = 1; i < biomarkers.length; i++) {
                const valueElement = document.getElementById(biomarkers[i].id);
                const value = parseInput(valueElement.value);
                markerValues.push(value);
            }

            // Calculate PhenoAge using the helper function
            const phenoAge = calculatePhenoAge(markerValues, coefficients);

            // Display the result
            document.getElementById('phenoAgeResult').innerText = `Your PhenoAge is ${phenoAge.toFixed(2)} years.`;

            // Show the Next button
            document.getElementById('continueButton').style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            const yearSelect = document.getElementById('dob-year');
            const currentYear = new Date().getFullYear();

            for (let year = currentYear; year >= 1908; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }

            updateDays(); // Added line

            // Check if the URL has the query parameter "fake=1"
            const urlParams = new URLSearchParams(window.location.search);
            const isFake = urlParams.get('fake') === '1';
            if (isFake) {
                fillFakeData();
            }
        });

        function fillFakeData() {
            // Set fake Date of Birth
            document.getElementById('dob-year').value = 1985;
            document.getElementById('dob-month').value = 10;
            document.getElementById('dob-day').value = 15;

            // Set fake values for all input fields
            document.getElementById('albumin').value = 45; // g/L
            document.getElementById('albuminUnit').value = 1; // g/L

            document.getElementById('creatinine').value = 80; // µmol/L
            document.getElementById('creatinineUnit').value = 1; // µmol/L

            document.getElementById('glucose').value = 5; // mmol/L
            document.getElementById('glucoseUnit').value = 1; // mmol/L

            document.getElementById('crp').value = 1; // mg/L
            document.getElementById('crpUnit').value = 10; // mg/L

            document.getElementById('lymphocyte').value = 30; // %
            document.getElementById('lymphocyteUnit').value = 1; // %

            document.getElementById('mcv').value = 90; // fL
            document.getElementById('mcvUnit').value = 1; // fL

            document.getElementById('rcdw').value = 12; // %
            document.getElementById('rcdwUnit').value = 1; // %

            document.getElementById('ap').value = 70; // U/L
            document.getElementById('apUnit').value = 1; // U/L

            document.getElementById('wbc').value = 6; // 1000 cells/μL
            document.getElementById('wbcUnit').value = 1; // 1000 cells/μL

            // Calculate result after filling fake data
            calculateResult();
        }

        function updateDays() {
            const year = parseInt(document.getElementById('dob-year').value);
            const month = parseInt(document.getElementById('dob-month').value);
            const daySelect = document.getElementById('dob-day');

            // Clear existing options
            daySelect.innerHTML = '<option value="" disabled selected>Select Day</option>';

            if (month) {
                const monthIndex = month - 1; // Adjust to 0-based index
                const tempYear = year || 2001; // Use selected year or default
                const lastDay = new Date(tempYear, month, 0).getDate(); // month is 1-based here
                for (let day = 1; day <= lastDay; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = lastDay;
            } else {
                // Default to 31 days
                for (let day = 1; day <= 31; day++) {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    daySelect.appendChild(option);
                }
                daySelect.value = 31;
            }
        }

        document.getElementById('dob-year').addEventListener('change', updateDays);
        document.getElementById('dob-month').addEventListener('change', updateDays);
    </script>
</body>
</html>