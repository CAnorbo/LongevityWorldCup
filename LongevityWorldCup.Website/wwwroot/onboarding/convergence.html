<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
    <link rel="stylesheet" href="/css/bioageform.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .option-button.already-have {
            background-color: #4CAF50; /* Green */
        }

            .option-button.already-have:hover {
                background-color: #388E3C; /* Darker Green */
            }

        /* Responsive adjustments */
        @media (max-width: 600px) {

            .option-button {
                font-size: 1rem;
            }
        }

        #nationality {
            margin-bottom: 0; /* Reset any margin added here */
        }

        .error-message {
            color: red;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: block;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            z-index: 9999;
            max-height: 150px; /* Limit height if needed */
            overflow-y: auto; /* Allow scrolling if the list is long */
            width: 100%; /* Make sure it matches the width of the container */
            top: 0; /* Keep this 0 because we are aligning relative to the input field */
            left: 0;
            margin-top: 0.5rem; /* Add a small margin to create separation */
        }

        /* Add a new class for the pointer cursor */
        .clickable {
            cursor: pointer;
        }

        /* Style for the cropping image */
        #cropperImage {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        #proofImageContainer div {
            position: relative;
            display: inline-block;
            margin: 0.5rem;
        }

        #proofImageContainer img {
            max-width: 200px;
            border: 2px solid #333;
            border-radius: 8px;
        }

        #proofImageContainer button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2>1. Character Creation</h2>
        <form id="descriptionForm" class="bioageform">
            <div style="text-align: center;">
                <img src="../assets/reaper.jpg" alt="Grim Reaper" class="illustration" id="illustrationImage">
            </div>
            <!--SUB-PROGRESS-BAR-->
            <div id="content">
                In the shadows beyond our world, <strong>Death awaits</strong>, silent and relentless. It lurks at the edge of every breath, ready to claim its due.
                In these darkening times, we need a <strong>hero to rise</strong> — a mind sharp enough to craft a plan, a spirit bold enough to face the inevitable.
                Death will come — but who will stand in its path?<br />
                <em>Could it be you?</em>
            </div>
        </form>

        <form id="inputForm" class="bioageform">
            <fieldset id="personalDetails">
                <!-- Name Field -->
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required aria-required="true" placeholder="Real name or cyber alias — your call">
                <span id="nameError" class="error-message"></span>

                <!-- Division Field -->
                <label for="division">Division:</label>
                <select id="division" name="division" required aria-required="true">
                    <!-- Options will be populated dynamically -->
                </select>

                <!-- Nationality Field with Autocomplete -->
                <label for="nationality">Flag:</label>
                <input type="text" id="nationality" name="nationality" required aria-required="true" autocomplete="off" placeholder="Cyberspace">
            </fieldset>
            <div id="privacyDetails">
                <p>Top-ranked longevity athletes will occasionally be asked to give an interview before their results are posted. Declining means no spot on the leaderboard. By proceeding, you agree to this.</p>
                <p><em>Remember, we’re not gonna beat Death by hiding in the shadows.</em></p>
            </div>
            <div id="profileUploadSection" style="width:90%;">
                <div id="uploadPart" style="display:block">
                    <p><strong>Upload a clear headshot:</strong></p>
                    <ol style="padding-left: 20px; line-height: 1.6;">
                        <li>It must be you.</li>
                        <li>Face the camera directly.</li>
                        <li>Include head and shoulders.</li>
                    </ol>
                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1rem;">
                        <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                        <button type="button" id="uploadButton" class="option-button">Upload Profile Picture</button>
                    </div>
                </div>
                <div id="croppingPart" style="display:none">
                    <img id="cropperImage" src="" style="max-width: 100%; display: block; margin: 0 auto;">
                    <button type="button" id="cropButton" class="option-button" style="margin-top: 1rem; display: block; margin: 1rem auto 0;">
                        Crop and Save
                    </button>
                </div>
            </div>
            <div id="proofUploadSection" style="width:90%;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1rem;">
                    <input type="file" id="proofPicInput" accept="image/*" style="display: none;" multiple>
                    <button type="button" id="uploadProofButton" class="option-button">Upload Proof Images</button>
                </div>
            </div>
            <fieldset id="finalDetails">
                <!-- Link to Personal Page (Optional) -->
                <label for="personalLink">Link (Optional):</label>
                <input type="url" id="personalLink" name="personalLink" placeholder="https://yourwebsite.com">
                <p style="margin-top: 0.5rem; color: #555;">
                    Provide a link to your personal page, social media profile, or any other online presence you wish to advertise.
                </p>

                <!-- Media Contact (Required) -->
                <label for="mediaContact">Media Contact:</label>
                <input type="email" id="mediaContact" name="mediaContact" required aria-required="true" placeholder="media@youremail.com">

                <p style="margin-top: 0.5rem; color: #555;">
                    Please provide a media contact email. Be cautious about using your personal email address. It is recommended to create a dedicated email (e.g.: <a href="https://protonmail.com" target="_blank">ProtonMail</a>) or use a social media account like Instagram or Twitter if your messages are open.
                </p>
            </fieldset>
            <fieldset id="applyDetails">
                <!-- Email Field -->
                <legend for="accountEmail">Email</legend>
                <input type="email" id="accountEmail" name="accountEmail" required aria-required="true" placeholder="yourname@example.com">
            </fieldset>

            <!-- New WHY Field (Initially Hidden) -->
            <div id="whyField" style="width:90%; display: none;">
                <label for="why">What drives you forward?</label>
                <textarea id="why" name="why" rows="5"></textarea>
            </div>

            <!-- Proof Image Container -->
            <fieldset id="proofImageContainer" style="text-align: center; margin-top: 1rem;"></fieldset>

            <div class="options-container">
                <button type="button" class="option-button already-have" id="nextButton" aria-label="Proceed to the next stage">Next</button>
                <button type="button" class="option-button back-button" id="backButton">
                    <i class="fas fa-arrow-left"></i>&nbsp;Back
                </button>
            </div>
        </form>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script src="/js/divisionIcons.js"></script>
    <script>
        var currentStage = 1;

        // Update the progress bar to the appropriate stage
        // Assuming updateMainProgress and updateSubProgress are defined elsewhere
        updateMainProgress(3);
        updateSubProgress(1);

        // Function to update the UI based on the current stage
        function goToStage(stage) {
            // Clear visibility on all main form sections
            document.getElementById('personalDetails').style.display = 'none';
            document.getElementById('privacyDetails').style.display = 'none';
            document.getElementById('profileUploadSection').style.display = 'none';
            document.getElementById('proofUploadSection').style.display = 'none';
            document.getElementById('whyField').style.display = 'none';
            document.getElementById('proofImageContainer').style.display = 'none';
            document.getElementById('finalDetails').style.display = 'none';
            document.getElementById('applyDetails').style.display = 'none';

            // Reset the illustrationImage to be clickable or not based on stage
            const illustrationImage = document.getElementById('illustrationImage');
            const nextButton = document.getElementById('nextButton');

            // Remove 'clickable' class initially
            illustrationImage.classList.remove('clickable');

            switch (stage) {
                case 1:
                    // Stage 1: Character Creation
                    document.querySelector('h2').textContent = "1. Character Creation";
                    illustrationImage.src = "../assets/reaper.jpg";
                    illustrationImage.alt = "Grim Reaper";
                    document.getElementById('content').innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                In the shadows beyond our world, <strong>Death awaits</strong>, silent and relentless. It lurks at the edge of every breath, ready to claim its due.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                In these darkening times, we need a <strong>hero to rise</strong> — a mind sharp enough to craft a plan, a spirit bold enough to face the inevitable.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Death will come — but who will stand in its path?<br />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <em>Could it be you?</em>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
                    document.getElementById('personalDetails').style.display = '';
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(1);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Add event listeners for validation
                    const nameInput = document.getElementById('name');
                    const nationalityInput = document.getElementById('nationality');

                    nameInput.addEventListener('input', checkFormValidityStage1);
                    nationalityInput.addEventListener('input', checkFormValidityStage1);

                    nameInput.addEventListener('blur', function () {
                        const nameValue = nameInput.value.trim();
                        const nameValid = isValidName(nameValue);

                        const nameError = document.getElementById('nameError');
                        if (!nameValid) {
                            nameError.textContent = 'Invalid name.';
                        } else {
                            nameError.textContent = '';
                        }
                    });

                    // Run checkFormValidityStage1 initially
                    checkFormValidityStage1();
                    break;
                case 2:
                    // Stage 2: Finding Your Why
                    document.querySelector('h2').textContent = "2. Finding Your Why";
                    illustrationImage.src = "../assets/why.jpg";
                    illustrationImage.alt = "Eye";
                    document.getElementById('content').innerHTML = `<p>He who has a <em>why</em> can bear almost any <em>how.</em></p>`;
                    document.getElementById('whyField').style.display = 'block';
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(2);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Add event listener for validation
                    const whyInput = document.getElementById('why');
                    whyInput.addEventListener('input', checkFormValidityStage2);

                    // Run checkFormValidityStage2 initially
                    checkFormValidityStage2();
                    break;
                case 3:
                    // Stage 3: The Price of Glory
                    document.querySelector('h2').textContent = "3. The Price of Glory";
                    illustrationImage.src = "../assets/cr7.jpg";
                    illustrationImage.alt = "Cristiano Ronaldo";
                    document.getElementById('content').innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p style="text-align: center;"><strong>Privacy is your ability to selectively reveal yourself to the world.</strong></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Cristiano Ronaldo is one of the greatest football players of all time. Put yourself into his boots. You must work hard, of course, but your job doesn't end with honing your skills. You also need to display them in front of millions of people. <em>There’s no sport without spectators.</em>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    So, does he lack privacy? <strong>No</strong>, he made a conscious decision to selectively reveal himself to the world.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <em>It's now your turn to make that decision.</em>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
                    document.getElementById('privacyDetails').style.display = '';
                    // In the goToStage function, within case 3, replace the existing line with the following:
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(3);
                    nextButton.textContent = 'Bring it on!';

                    // Enable Next button
                    nextButton.disabled = false;
                    nextButton.classList.remove('disabled-button');
                    break;
                case 4:
                    // Stage 4: Almost There
                    document.querySelector('h2').textContent = "4. Almost There";
                    illustrationImage.src = "../assets/headshot.jpg";
                    illustrationImage.alt = "Headshot";
                    document.getElementById('content').innerHTML = `<p>Next, provide your profile picture. Smiling is optional!</p>`;
                    document.getElementById('profileUploadSection').style.display = '';

                    illustrationImage.classList.add('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    updateSubProgress(4);

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Check if there is a stored profile picture
                    const storedProfilePic = localStorage.getItem('profilePic');
                    if (storedProfilePic) {
                        illustrationImage.src = storedProfilePic;
                        // Enable Next button if profile picture exists
                        nextButton.disabled = false;
                        nextButton.classList.remove('disabled-button');
                    }

                    // Attach event listeners for upload
                    attachUploadEventListeners();
                    break;
                case 5:
                    // Stage 5: Don't Trust Verify
                    document.querySelector('h2').textContent = "5. Don't Trust Verify";
                    illustrationImage.src = "../assets/proof.jpg";
                    illustrationImage.alt = "Proof Image";
                    document.getElementById('content').innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>Upload <strong>image proofs</strong> of your biomarkers.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p>These images will be <strong>public</strong>, so you're encouraged to censor any irrelevant information.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
                    document.getElementById('proofUploadSection').style.display = '';

                    illustrationImage.classList.remove('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');
                    nextButton.classList.add("disabled-button");

                    // Attach event listener to the Upload Proof button
                    document.getElementById('uploadProofButton').addEventListener('click', function () {
                        document.getElementById('proofPicInput').click();
                    });

                    // Handle the image upload (without cropping)
                    document.getElementById('proofPicInput').addEventListener('change', function (event) {
                        const files = event.target.files;
                        if (files.length > 0) {
                            // Retrieve existing proof images from localStorage
                            let proofPics = JSON.parse(localStorage.getItem('proofPics')) || [];

                            // Limit the total number of images to 9
                            if (proofPics.length + files.length > 9) {
                                alert('You can upload a maximum of 9 images.');
                                return;
                            }

                            for (let i = 0; i < files.length; i++) {
                                const file = files[i];
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    proofPics.push(e.target.result);
                                    // Store the updated proofPics array
                                    localStorage.setItem('proofPics', JSON.stringify(proofPics));
                                    // Update the display
                                    updateProofImageContainer();
                                    // Check proof images
                                    checkProofImages();
                                };
                                reader.readAsDataURL(file);
                            }
                        }
                        // Reset the file input's value to allow re-uploading the same file if needed
                        document.getElementById('proofPicInput').value = "";
                    });

                    document.getElementById('proofImageContainer').style.display = 'block';

                    // Display any existing proof images
                    updateProofImageContainer();

                    // Disable Next button initially
                    nextButton.disabled = true;
                    nextButton.classList.add('disabled-button');

                    // Check if proof images already exist
                    checkProofImages();
                    break;
                case 6:
                    // Stage 6: Final Details
                    document.querySelector('h2').textContent = "6. Final Details";
                    illustrationImage.src = "../assets/finish.jpg";
                    illustrationImage.alt = "Finish Line";
                    document.getElementById('content').innerHTML = "<p style='text-align: center; font-weight: bold;'>Final Details</p>";

                    document.getElementById('finalDetails').style.display = '';

                    illustrationImage.classList.remove('clickable');
                    nextButton.innerHTML = 'Next&nbsp;<i class="fas fa-arrow-right"></i>';
                    nextButton.setAttribute('type', 'button');

                    // Add event listener for validation
                    const mediaContactInput = document.getElementById('mediaContact');
                    mediaContactInput.addEventListener('input', checkFormValidityStage6);

                    // Run checkFormValidityStage6 initially
                    checkFormValidityStage6();

                    break;
                case 7:
                    // Stage 7: Application
                    document.querySelector('h2').textContent = "5. Application";
                    illustrationImage.src = "../assets/account-creation.jpg";
                    illustrationImage.alt = "Application";
                    document.getElementById('content').innerHTML = "<p>Congrats! All that's left to do is to provide your contact email.</p>";

                    document.getElementById('applyDetails').style.display = '';

                    illustrationImage.classList.remove('clickable');
                    nextButton.textContent = 'Apply';
                    nextButton.setAttribute('type', 'submit');
                    updateSubProgress(5);

                    const accountEmailInput = document.getElementById('accountEmail');
                    accountEmailInput.addEventListener('input', checkFormValidityStage7);

                    // Run checkFormValidityStage7 initially
                    checkFormValidityStage7();
                    break;
                default:
                    console.error('Unknown stage:', stage);
            }
        }

        // Nationality Autocomplete Implementation
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize the first stage
            goToStage(currentStage);

            fetch('/api/data/flags')
                .then(response => response.json())
                .then(countries => {
                    const nationalityInput = document.getElementById('nationality');

                    nationalityInput.addEventListener('input', function () {
                        const inputVal = this.value.toLowerCase();
                        closeAllLists();
                        if (!inputVal) return false;

                        const listContainer = document.createElement('div');
                        listContainer.setAttribute('id', this.id + '-autocomplete-list');
                        listContainer.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(listContainer);

                        let matchCount = 0;

                        for (let i = 0; i < countries.length; i++) {
                            if (countries[i].toLowerCase().startsWith(inputVal)) {
                                const listItem = document.createElement('div');
                                listItem.innerHTML = "<strong>" + countries[i].substr(0, inputVal.length) + "</strong>";
                                listItem.innerHTML += countries[i].substr(inputVal.length);
                                listItem.innerHTML += "<input type='hidden' value='" + countries[i] + "'>";
                                listItem.addEventListener('click', function () {
                                    nationalityInput.value = this.getElementsByTagName('input')[0].value;
                                    closeAllLists();
                                });
                                listContainer.appendChild(listItem);
                                matchCount++;
                                if (matchCount >= 5) break; // Limit to 5 suggestions
                            }
                        }
                    });

                    function closeAllLists(elmnt) {
                        const items = document.getElementsByClassName('autocomplete-items');
                        for (let i = 0; i < items.length; i++) {
                            if (elmnt != items[i] && elmnt != nationalityInput) {
                                items[i].parentNode.removeChild(items[i]);
                            }
                        }
                    }

                    document.addEventListener('click', function (e) {
                        closeAllLists(e.target);
                    });
                })
                .catch(error => {
                    console.error('Error fetching flags:', error);
                });

            // Fetch divisions and populate the division select element
            fetch('/api/data/divisions')
                .then(response => response.json())
                .then(divisions => {
                    const divisionSelect = document.getElementById('division');

                    // Clear existing options (if any)
                    divisionSelect.innerHTML = '';

                    // Populate divisions into the select element
                    divisions.forEach(function (division) {
                        const option = document.createElement('option');
                        option.value = division.toLowerCase(); // Use lowercase or any appropriate value
                        option.textContent = `${window.GetDivisionIcon(division)} ${division}`;
                        divisionSelect.appendChild(option);
                    });

                    // Optionally, set a default value or prompt
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '-- Select Division --';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    divisionSelect.insertBefore(defaultOption, divisionSelect.firstChild);

                    if (currentStage === 1) {
                        divisionSelect.addEventListener('change', checkFormValidityStage1);
                        checkFormValidityStage1(); // Check validity in case other fields are already filled
                    }
                })
                .catch(error => {
                    console.error('Error fetching divisions:', error);
                });
        });

        // Form Submission Handler
        document.getElementById('inputForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission

            // Collect form data based on current stage
            let isValid = true;
            let formData = {};

            if (currentStage >= 1 && currentStage <= 2) {
                // Stage 1 and 2 require name, division, nationality, and why
                const name = document.getElementById('name').value.trim();
                const division = document.getElementById('division').value;
                const nationality = document.getElementById('nationality').value.trim();
                const why = document.getElementById('why').value.trim();

                if (!name || !division || !nationality || !why) {
                    isValid = false;
                } else {
                    formData = { name, division, nationality, why };
                }
            }

            if (currentStage === 7) {
                // Final stage requires accountEmail
                const accountEmail = document.getElementById('accountEmail').value.trim();
                if (!accountEmail) {
                    isValid = false;
                } else {
                    formData.accountEmail = accountEmail;
                }
            }

            // Additional validation can be added here for other stages

            if (isValid) {
                // Store data in localStorage or proceed as needed
                for (const key in formData) {
                    localStorage.setItem(key, formData[key]);
                }

                if (currentStage === 7) {
                    // Proceed to final submission or next steps
                    alert('Account created successfully!');
                    // You can redirect the user or perform other actions here
                    window.location.href = 'onboarding/application-review.html';
                } else {
                    // Navigate to the next stage if not on the final stage
                    document.getElementById('nextButton').click();
                }
            } else {
                alert('Please fill in all required fields.');
            }
        });

        // "Next" Button Click Event Handler
        document.getElementById('nextButton').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default button action

            // Scroll the heading into view
            document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });

            // Remove the 'clickable' class from the illustrationImage
            document.getElementById('illustrationImage').classList.remove('clickable');

            if (currentStage < 7) {
                currentStage++;
                goToStage(currentStage);
            } else {
                // This is the final stage
                window.location.href = 'onboarding/application-review.html';
            }
        });

        // "Back" Button Click Event Handler
        document.getElementById('backButton').addEventListener('click', function () {
            if (currentStage > 1) {
                currentStage--;
                goToStage(currentStage);
            } else {
                // If on the first stage, go back to the previous page
                window.history.back();
            }
        });

        function attachUploadEventListeners() {
            // Set up event listener for the upload button
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton && !uploadButton.hasAttribute('data-listener')) {
                uploadButton.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                uploadButton.setAttribute('data-listener', 'true');
            }

            // Add click event to the image to trigger file selection
            const illustrationImage = document.getElementById('illustrationImage');
            if (illustrationImage && !illustrationImage.hasAttribute('data-listener')) {
                illustrationImage.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                illustrationImage.setAttribute('data-listener', 'true');
            }

            // Handle the image upload and initialize Cropper.js
            const profilePicInput = document.getElementById('profilePicInput');
            let cropper; // Declare Cropper instance at a higher scope

            if (profilePicInput && !profilePicInput.hasAttribute('data-listener')) {
                profilePicInput.addEventListener('change', function (event) {
                    if (!event.target.files.length) return; // Reset if no file selected
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Disable "Next" button while cropping
                            const nextButton = document.getElementById('nextButton');
                            nextButton.disabled = true;
                            nextButton.classList.add('disabled-button');

                            document.getElementById('cropperImage').src = e.target.result;

                            document.getElementById('uploadPart').style.display = 'none';
                            document.getElementById('croppingPart').style.display = 'block';

                            // Initialize Cropper only once
                            if (!cropper) {
                                cropper = new Cropper(document.getElementById('cropperImage'), {
                                    aspectRatio: 1024 / 768,
                                    viewMode: 1,
                                    autoCropArea: 1,
                                    movable: true,
                                    zoomable: true,
                                    rotatable: false,
                                    scalable: false,
                                    cropBoxResizable: true,
                                    minCropBoxWidth: 200,
                                    minCropBoxHeight: 150,
                                });
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Add the crop button event listener once
                document.getElementById('cropButton').addEventListener('click', function () {
                    if (cropper) {
                        const croppedCanvas = cropper.getCroppedCanvas({
                            width: 1024,
                            height: 768,
                        });
                        const croppedImageDataURL = croppedCanvas.toDataURL('image/png');
                        document.getElementById('illustrationImage').src = croppedImageDataURL;

                        localStorage.setItem('profilePic', croppedImageDataURL);

                        cropper.destroy(); // Clean up the Cropper instance
                        cropper = null; // Reset the Cropper instance

                        document.getElementById('uploadPart').style.display = '';
                        document.getElementById('croppingPart').style.display = 'none';

                        const nextButton = document.getElementById('nextButton');
                        nextButton.disabled = false;
                        nextButton.classList.remove('disabled-button');

                        attachUploadEventListeners();
                    }
                });

                profilePicInput.setAttribute('data-listener', 'true');
            }
        }

        function updateProofImageContainer() {
            let container = document.getElementById('proofImageContainer');
            container.innerHTML = '';
            // Retrieve existing proof images from localStorage
            let proofPics = JSON.parse(localStorage.getItem('proofPics')) || [];
            if (proofPics.length > 0) {
                container.innerHTML = '<p><strong>Proof uploaded successfully.</strong></p>';
                for (let i = 0; i < proofPics.length; i++) {
                    let imgContainer = document.createElement('div');
                    imgContainer.style = 'position: relative; display: inline-block; margin: 0.5rem;';

                    let img = document.createElement('img');
                    img.src = proofPics[i];
                    img.alt = 'Proof Image ' + (i + 1);
                    img.style = 'max-width: 100%; border: 2px solid #333; border-radius: 8px;';

                    let removeButton = document.createElement('button');
                    removeButton.textContent = 'Remove';
                    removeButton.style = 'position: absolute; top: 5px; right: 5px; background-color: rgba(255, 0, 0, 0.7); color: white; border: none; border-radius: 3px; cursor: pointer;';
                    removeButton.addEventListener('click', function () {
                        proofPics.splice(i, 1);
                        localStorage.setItem('proofPics', JSON.stringify(proofPics));
                        updateProofImageContainer();
                        // Check proof images
                        checkProofImages();
                    });

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(removeButton);
                    container.appendChild(imgContainer);
                }
            }
        }

        function checkProofImages() {
            if (currentStage !== 5) return;

            const nextButton = document.getElementById('nextButton');
            let proofPics = JSON.parse(localStorage.getItem('proofPics')) || [];

            if (proofPics.length > 0) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function checkFormValidityStage1() {
            if (currentStage !== 1) return;

            const nameInput = document.getElementById('name');
            const divisionSelect = document.getElementById('division');
            const nationalityInput = document.getElementById('nationality');
            const nextButton = document.getElementById('nextButton');

            const nameValue = nameInput.value.trim();
            const nameValid = isValidName(nameValue);
            const divisionSelected = divisionSelect && divisionSelect.value.trim() !== '';
            const nationalityFilled = nationalityInput.value.trim() !== '';

            if (nameValid) {
                nameError.textContent = '';
            }
            if (nameValid && divisionSelected && nationalityFilled) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function checkFormValidityStage2() {
            if (currentStage !== 2) return;

            const whyInput = document.getElementById('why');
            const nextButton = document.getElementById('nextButton');

            const whyFilled = whyInput.value.trim() !== '';

            if (whyFilled) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }
        function checkFormValidityStage6() {
            if (currentStage !== 6) return;

            const mediaContactInput = document.getElementById('mediaContact');
            const nextButton = document.getElementById('nextButton');

            const mediaContactFilled = mediaContactInput.value.trim() !== '';

            if (mediaContactFilled) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }
        function checkFormValidityStage7() {
            if (currentStage !== 7) return;

            const accountEmailInput = document.getElementById('accountEmail');
            const nextButton = document.getElementById('nextButton');

            const emailFilled = accountEmailInput.value.trim() !== '';

            if (emailFilled) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled-button');
            } else {
                nextButton.disabled = true;
                nextButton.classList.add('disabled-button');
            }
        }

        function isValidName(name) {
            // Trim leading and trailing whitespace
            name = name.trim();

            // Ensure the name is at least 3 characters long
            if (name.length < 3) return false;

            // Regular expression to validate the name
            const nameRegex = /^[A-Za-zÀ-ÖØ-öø-ÿ][A-Za-zÀ-ÖØ-öø-ÿ0-9\s'-]{2,99}$/;

            return nameRegex.test(name);
        }
    </script>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
</body>
</html>