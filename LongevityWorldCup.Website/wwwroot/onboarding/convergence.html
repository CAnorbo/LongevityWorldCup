<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        /* Button Styles */
        .options-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
        }

        .option-button {
            padding: 1rem 2rem;
            margin: 0.5rem 0;
            font-size: 1.2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 80%;
            max-width: 400px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .option-button:hover {
                background-color: var(--secondary-color);
                transform: scale(1.03);
            }

            .option-button.already-have {
                background-color: #4CAF50; /* Green */
            }

                .option-button.already-have:hover {
                    background-color: #388E3C; /* Darker Green */
                }

        /* Form Styles */
        .bioageform {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

            .bioageform label {
                display: block;
                margin-top: 1rem;
                font-weight: bold;
                color: #333;
            }

            .bioageform input,
            .bioageform select {
                width: 100%;
                padding: 0.5rem;
                margin-top: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .bioageform {
                padding: 1rem;
            }

            .option-button {
                font-size: 1rem;
            }
        }

        /* Adjust the back button styling */
        .back-button {
            background-color: #607D8B;
        }

            .back-button:hover {
                background-color: #455A64;
            }

        #nationality {
            margin-bottom: 0; /* Reset any margin added here */
        }

        .bioageform {
            position: relative; /* Position relative to make dropdown align correctly */
        }

            .bioageform textarea {
                width: 100%;
                padding: 0.5rem;
                margin-top: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
                resize: vertical; /* Allow users to resize vertically */
            }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            z-index: 9999;
            max-height: 150px; /* Limit height if needed */
            overflow-y: auto; /* Allow scrolling if the list is long */
            width: 100%; /* Make sure it matches the width of the container */
            top: 0; /* Keep this 0 because we are aligning relative to the input field */
            left: 0;
            margin-top: 0.5rem; /* Add a small margin to create separation */
        }

        .illustration {
            width: 100%;
            height: auto;
            max-width: 400px;
            display: block;
            margin: 0 auto 1.5rem;
            border: 4px solid #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2>1. Character Creation</h2>
        <form id="personalInfoForm" class="bioageform">
            <div style="text-align: center;">
                <img src="../assets/reaper.jpg" alt="Grim Reaper" class="illustration" id="illustrationImage">
            </div>
            <!--SUB-PROGRESS-BAR-->
            <div id="content">
                In the shadows beyond our world, <strong>Death awaits</strong>, silent and relentless. It lurks at the edge of every breath, ready to claim its due.
                In these darkening times, we need a <strong>hero to rise</strong> — a mind sharp enough to craft a plan, a spirit bold enough to face the inevitable.
                Death will come — but who will stand in its path?<br />
                <em>Could it be you?</em>
            </div>
        </form>

        <form id="personalInfoForm" class="bioageform">
            <div id="personalDetails">
                <!-- Name Field -->
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required aria-required="true" placeholder="Real name or cyber alias — your call">

                <!-- Division Field -->
                <label for="division">Division:</label>
                <select id="division" name="division" required aria-required="true">
                    <!-- Options will be populated dynamically -->
                </select>

                <!-- Nationality Field with Autocomplete -->
                <label for="nationality">Flag:</label>
                <input type="text" id="nationality" name="nationality" required aria-required="true" autocomplete="off" placeholder="Cyberspace">
            </div>

            <!-- New WHY Field (Initially Hidden) -->
            <div id="whyField" style="display: none;">
                <label for="why">What drives you forward?</label>
                <textarea id="why" name="why" rows="5"></textarea>
            </div>
        </form>

        <div class="options-container">
            <button type="button" class="option-button calculate-button already-have" id="nextButton" aria-label="Proceed to the next stage">Next</button>
            <button class="option-button back-button" onclick="window.history.back()">Go Back</button>
        </div>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script>
        var currentStage = 1;

        // Update the progress bar to the appropriate stage
        updateMainProgress(3);
        updateSubProgress(1);

        // Nationality Autocomplete Implementation
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/data/flags')
                .then(response => response.json())
                .then(countries => {
                    const nationalityInput = document.getElementById('nationality');

                    nationalityInput.addEventListener('input', function () {
                        const inputVal = this.value.toLowerCase();
                        closeAllLists();
                        if (!inputVal) return false;

                        const listContainer = document.createElement('div');
                        listContainer.setAttribute('id', this.id + '-autocomplete-list');
                        listContainer.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(listContainer);

                        let matchCount = 0;

                        for (let i = 0; i < countries.length; i++) {
                            if (countries[i].toLowerCase().startsWith(inputVal)) {
                                const listItem = document.createElement('div');
                                listItem.innerHTML = "<strong>" + countries[i].substr(0, inputVal.length) + "</strong>";
                                listItem.innerHTML += countries[i].substr(inputVal.length);
                                listItem.innerHTML += "<input type='hidden' value='" + countries[i] + "'>";
                                listItem.addEventListener('click', function () {
                                    nationalityInput.value = this.getElementsByTagName('input')[0].value;
                                    closeAllLists();
                                });
                                listContainer.appendChild(listItem);
                                matchCount++;
                                if (matchCount >= 5) break; // Limit to 5 suggestions
                            }
                        }
                    });

                    function closeAllLists(elmnt) {
                        const items = document.getElementsByClassName('autocomplete-items');
                        for (let i = 0; i < items.length; i++) {
                            if (elmnt != items[i] && elmnt != nationalityInput) {
                                items[i].parentNode.removeChild(items[i]);
                            }
                        }
                    }

                    document.addEventListener('click', function (e) {
                        closeAllLists(e.target);
                    });
                })
                .catch(error => {
                    console.error('Error fetching flags:', error);
                });
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Fetch flags and initialize nationality autocomplete
            fetch('/api/data/flags')
                .then(response => response.json())
                .then(countries => {
                    // Existing code for nationality autocomplete...
                })
                .catch(error => {
                    console.error('Error fetching flags:', error);
                });

            // Fetch divisions and populate the division select element
            fetch('/api/data/divisions')
                .then(response => response.json())
                .then(divisions => {
                    const divisionSelect = document.getElementById('division');

                    // Clear existing options (if any)
                    divisionSelect.innerHTML = '';

                    // Populate divisions into the select element
                    divisions.forEach(function (division) {
                        const option = document.createElement('option');
                        option.value = division.toLowerCase(); // Use lowercase or any appropriate value
                        option.textContent = division; // Display text as is
                        divisionSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching divisions:', error);
                });
        });

        // Form Submission Handler
        document.getElementById('personalInfoForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission

            // Collect form data
            var name = document.getElementById('name').value.trim();
            var division = document.getElementById('division').value;
            var nationality = document.getElementById('nationality').value.trim();
            var why = document.getElementById('why').value.trim(); // Collect the WHY input

            // Validate form data
            if (name && division && nationality && why) {
                // Store data in localStorage or proceed as needed
                localStorage.setItem('name', name);
                localStorage.setItem('division', division);
                localStorage.setItem('nationality', nationality);
                localStorage.setItem('why', why); // Store the WHY value

                if (currentStage === 3) {
                    // Proceed to the next stage or final submission
                    window.location.href = 'nextstage.html';
                } else {
                    // Do nothing or provide feedback if needed
                    alert('Please complete all stages before submitting.');
                }
            } else {
                alert('Please fill in all required fields.');
            }
        });

        // "Next" Button Click Event Handler
        document.getElementById('nextButton').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default button action

            if (currentStage === 1) {
                // Proceed to Stage 2
                // Change image source and text content
                document.getElementById('illustrationImage').src = "../assets/why.jpg";
                document.getElementById('illustrationImage').alt = "Eye";
                document.querySelector('h2').textContent = "2. Finding Your Why";
                updateSubProgress(2);

                // Scroll the heading into view
                document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });

                // Hide the initial form fields
                document.getElementById('personalDetails').style.display = 'none';

                // Show the "Your WHY:" field
                document.getElementById('whyField').style.display = 'block';

                // Update the text content for the "Why" section
                document.getElementById('content').innerHTML = `<p>He who has a <em>why</em> can bear almost any <em>how.</em></p>`;

                currentStage = 2;

                // Optionally, update the button text
                this.textContent = 'Next';
            } else if (currentStage === 2) {
                // Proceed to Stage 3
                currentStage = 3;

                // Hide the "Why" field
                document.getElementById('whyField').style.display = 'none';

                // Change image source and text content for stage 3
                document.getElementById('illustrationImage').src = "../assets/cr7.jpg";
                document.getElementById('illustrationImage').alt = "Cristiano Ronaldo";
                document.querySelector('h2').textContent = "3. The Price of Glory";
                updateSubProgress(3);

                // Update the text content for stage 3 with formatting
                document.getElementById('content').innerHTML = `
                                                                                                            <p style="text-align: center;"><strong>Privacy is your ability to selectively reveal yourself to the world.</strong></p>
                                                                                                            <p>
                                                                                                                Cristiano Ronaldo is one of the greatest football players of all time. Put yourself into his boots. You must work hard, of course, but your job doesn't end with honing your skills. You also need to display them in front of millions of people. <em>There’s no sport without spectators.</em>
                                                                                                            </p>
                                                                                                            <p>
                                                                                                                So, does he lack privacy? <strong>No</strong>, he made a conscious decision to selectively reveal himself to the world.
                                                                                                            </p>
                                                                                                            <p>
                                                                                                                <em>It's now your turn to make that decision.</em>
                                                                                                            </p>
                                                    `;

                // Add your specified text to the empty block (the div that held the input fields)
                document.getElementById('personalDetails').innerHTML = `
                                                <p>Top-ranked longevity athletes will occasionally be asked to give an interview before their results are posted. Declining means no spot on the leaderboard. By proceeding, you agree to this.</p>
                                                <p><em>Just remember, we’re not gonna beat Death by hiding in the shadows!</em></p>
                                            `;
                document.getElementById('personalDetails').style.display = '';

                // Change button text to 'Submit' and set type to 'submit' for final submission
                this.textContent = 'Submit';
                this.setAttribute('type', 'submit');
            }
        });
    </script>
</body>
</html>