<!DOCTYPE html>
<html lang="en">
<head>
    <!--HEAD-->
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css">
    <style>
        /* Hide the join-game button in the header */
        .join-game {
            display: none;
        }

        /* Button Styles */
        .options-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 2rem;
        }

        .option-button {
            padding: 1rem 2rem;
            margin: 0.5rem 0;
            font-size: 1.2rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 80%;
            max-width: 400px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .option-button:hover {
                background-color: var(--secondary-color);
                transform: scale(1.03);
            }

            .option-button.already-have {
                background-color: #4CAF50; /* Green */
            }

                .option-button.already-have:hover {
                    background-color: #388E3C; /* Darker Green */
                }

        /* Form Styles */
        .bioageform {
            max-width: 600px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

            .bioageform label {
                display: block;
                margin-top: 1rem;
                font-weight: bold;
                color: #333;
            }

            .bioageform input,
            .bioageform select {
                width: 100%;
                padding: 0.5rem;
                margin-top: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .bioageform {
                padding: 1rem;
            }

            .option-button {
                font-size: 1rem;
            }
        }

        /* Adjust the back button styling */
        .back-button {
            background-color: #607D8B;
        }

            .back-button:hover {
                background-color: #455A64;
            }

        #nationality {
            margin-bottom: 0; /* Reset any margin added here */
        }

        .bioageform {
            position: relative; /* Position relative to make dropdown align correctly */
        }

            .bioageform textarea {
                width: 100%;
                padding: 0.5rem;
                margin-top: 0.5rem;
                box-sizing: border-box;
                border: 1px solid #ccc;
                border-radius: 4px;
                resize: vertical; /* Allow users to resize vertically */
            }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            z-index: 9999;
            max-height: 150px; /* Limit height if needed */
            overflow-y: auto; /* Allow scrolling if the list is long */
            width: 100%; /* Make sure it matches the width of the container */
            top: 0; /* Keep this 0 because we are aligning relative to the input field */
            left: 0;
            margin-top: 0.5rem; /* Add a small margin to create separation */
        }

        .illustration {
            width: 100%;
            height: auto;
            max-width: 400px;
            display: block;
            margin: 0 auto 1.5rem;
            border: 4px solid #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }

        /* Add a new class for the pointer cursor */
        .clickable {
            cursor: pointer;
        }

        /* Style for the cropping image */
        #cropperImage {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!--HEADER-->
    <main>
        <!--MAIN-PROGRESS-BAR-->
        <h2>1. Character Creation</h2>
        <form id="descriptionForm" class="bioageform">
            <div style="text-align: center;">
                <img src="../assets/reaper.jpg" alt="Grim Reaper" class="illustration" id="illustrationImage">
            </div>
            <!--SUB-PROGRESS-BAR-->
            <div id="content">
                In the shadows beyond our world, <strong>Death awaits</strong>, silent and relentless. It lurks at the edge of every breath, ready to claim its due.
                In these darkening times, we need a <strong>hero to rise</strong> — a mind sharp enough to craft a plan, a spirit bold enough to face the inevitable.
                Death will come — but who will stand in its path?<br />
                <em>Could it be you?</em>
            </div>
        </form>

        <form id="inputForm" class="bioageform">
            <div id="personalDetails">
                <!-- Name Field -->
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required aria-required="true" placeholder="Real name or cyber alias — your call">

                <!-- Division Field -->
                <label for="division">Division:</label>
                <select id="division" name="division" required aria-required="true">
                    <!-- Options will be populated dynamically -->
                </select>

                <!-- Nationality Field with Autocomplete -->
                <label for="nationality">Flag:</label>
                <input type="text" id="nationality" name="nationality" required aria-required="true" autocomplete="off" placeholder="Cyberspace">
            </div>

            <!-- New WHY Field (Initially Hidden) -->
            <div id="whyField" style="display: none;">
                <label for="why">What drives you forward?</label>
                <textarea id="why" name="why" rows="5"></textarea>
            </div>

            <!-- Proof Image Container -->
            <div id="proofImageContainer" style="text-align: center; margin-top: 1rem;"></div>

            <div class="options-container">
                <button type="button" class="option-button calculate-button already-have" id="nextButton" aria-label="Proceed to the next stage">Next</button>
                <button class="option-button back-button" onclick="window.history.back()">Go Back</button>
            </div>
        </form>
    </main>
    <!--FOOTER-->
    <!-- JavaScript -->
    <script>
        var currentStage = 1;

        // Update the progress bar to the appropriate stage
        updateMainProgress(3);
        updateSubProgress(1);

        // Nationality Autocomplete Implementation
        document.addEventListener('DOMContentLoaded', function () {
            fetch('/api/data/flags')
                .then(response => response.json())
                .then(countries => {
                    const nationalityInput = document.getElementById('nationality');

                    nationalityInput.addEventListener('input', function () {
                        const inputVal = this.value.toLowerCase();
                        closeAllLists();
                        if (!inputVal) return false;

                        const listContainer = document.createElement('div');
                        listContainer.setAttribute('id', this.id + '-autocomplete-list');
                        listContainer.setAttribute('class', 'autocomplete-items');
                        this.parentNode.appendChild(listContainer);

                        let matchCount = 0;

                        for (let i = 0; i < countries.length; i++) {
                            if (countries[i].toLowerCase().startsWith(inputVal)) {
                                const listItem = document.createElement('div');
                                listItem.innerHTML = "<strong>" + countries[i].substr(0, inputVal.length) + "</strong>";
                                listItem.innerHTML += countries[i].substr(inputVal.length);
                                listItem.innerHTML += "<input type='hidden' value='" + countries[i] + "'>";
                                listItem.addEventListener('click', function () {
                                    nationalityInput.value = this.getElementsByTagName('input')[0].value;
                                    closeAllLists();
                                });
                                listContainer.appendChild(listItem);
                                matchCount++;
                                if (matchCount >= 5) break; // Limit to 5 suggestions
                            }
                        }
                    });

                    function closeAllLists(elmnt) {
                        const items = document.getElementsByClassName('autocomplete-items');
                        for (let i = 0; i < items.length; i++) {
                            if (elmnt != items[i] && elmnt != nationalityInput) {
                                items[i].parentNode.removeChild(items[i]);
                            }
                        }
                    }

                    document.addEventListener('click', function (e) {
                        closeAllLists(e.target);
                    });
                })
                .catch(error => {
                    console.error('Error fetching flags:', error);
                });

            // Fetch divisions and populate the division select element
            fetch('/api/data/divisions')
                .then(response => response.json())
                .then(divisions => {
                    const divisionSelect = document.getElementById('division');

                    // Clear existing options (if any)
                    divisionSelect.innerHTML = '';

                    // Populate divisions into the select element
                    divisions.forEach(function (division) {
                        const option = document.createElement('option');
                        option.value = division.toLowerCase(); // Use lowercase or any appropriate value
                        option.textContent = division; // Display text as is
                        divisionSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching divisions:', error);
                });
        });

        // Form Submission Handler
        document.getElementById('inputForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission

            // Collect form data
            var name = document.getElementById('name').value.trim();
            var division = document.getElementById('division').value;
            var nationality = document.getElementById('nationality').value.trim();
            var why = document.getElementById('why').value.trim(); // Collect the WHY input

            // Collect account creation data
            var accountEmail = document.getElementById('accountEmail').value.trim();

            // Validate form data
            if (name && division && nationality && why && accountEmail) {
                // Store data in localStorage or proceed as needed
                localStorage.setItem('name', name);
                localStorage.setItem('division', division);
                localStorage.setItem('nationality', nationality);
                localStorage.setItem('why', why); // Store the WHY value
                localStorage.setItem('accountEmail', accountEmail);

                if (currentStage === 7) {
                    // Proceed to final submission or next steps
                    alert('Account created successfully!');
                    // You can redirect the user or perform other actions here
                    window.location.href = 'onboarding/application-review.html';
                } else {
                    // Do nothing or provide feedback if needed
                    alert('Please complete all stages before submitting.');
                }
            } else {
                alert('Please fill in all required fields.');
            }
        });

        // "Next" Button Click Event Handler
        document.getElementById('nextButton').addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default button action

            // Scroll the heading into view
            document.querySelector('h2').scrollIntoView({ behavior: 'smooth' });

            // Remove the 'clickable' class from the illustrationImage
            document.getElementById('illustrationImage').classList.remove('clickable');

            if (currentStage === 1) {
                currentStage = 2;
                updateSubProgress(2);

                // Change image source and text content
                document.getElementById('illustrationImage').src = "../assets/why.jpg";
                document.getElementById('illustrationImage').alt = "Eye";
                document.querySelector('h2').textContent = "2. Finding Your Why";

                // Hide the initial form fields
                document.getElementById('personalDetails').style.display = 'none';

                // Show the "Your WHY:" field
                document.getElementById('whyField').style.display = 'block';

                // Update the text content for the "Why" section
                document.getElementById('content').innerHTML = `<p>He who has a <em>why</em> can bear almost any <em>how.</em></p>`;
            } else if (currentStage === 2) {
                currentStage = 3;
                updateSubProgress(3);

                // Hide the "Why" field
                document.getElementById('whyField').style.display = 'none';

                // Change image source and text content for stage 3
                document.getElementById('illustrationImage').src = "../assets/cr7.jpg";
                document.getElementById('illustrationImage').alt = "Cristiano Ronaldo";
                document.querySelector('h2').textContent = "3. The Price of Glory";

                // Update the text content for stage 3 with formatting
                document.getElementById('content').innerHTML = `
                                                                                                                                                                                                                                                                                                            <p style="text-align: center;"><strong>Privacy is your ability to selectively reveal yourself to the world.</strong></p>
                                                                                                                                                                                                                                                                                                            <p>
                                                                                                                                                                                                                                                                                                                Cristiano Ronaldo is one of the greatest football players of all time. Put yourself into his boots. You must work hard, of course, but your job doesn't end with honing your skills. You also need to display them in front of millions of people. <em>There’s no sport without spectators.</em>
                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                            <p>
                                                                                                                                                                                                                                                                                                                So, does he lack privacy? <strong>No</strong>, he made a conscious decision to selectively reveal himself to the world.
                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                            <p>
                                                                                                                                                                                                                                                                                                                <em>It's now your turn to make that decision.</em>
                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                        `;

                // Add your specified text to the empty block (the div that held the input fields)
                document.getElementById('personalDetails').innerHTML = `
                                                                                                                                                                                                                                                                                                            <p>Top-ranked longevity athletes will occasionally be asked to give an interview before their results are posted. Declining means no spot on the leaderboard. By proceeding, you agree to this.</p>
                                                                                                                                                                                                                                                                                                            <p><em>Just remember, we’re not gonna beat Death by hiding in the shadows!</em></p>
                                                                                                                                                                                                                                                                                                        `;
                document.getElementById('personalDetails').style.display = '';
            } else if (currentStage === 3) {
                currentStage = 4;
                updateSubProgress(4);

                // Add the 'clickable' class to the illustrationImage
                document.getElementById('illustrationImage').classList.add('clickable');

                document.querySelector('h2').textContent = "4. Almost There";
                document.getElementById('illustrationImage').src = "../assets/headshot.jpg";
                document.getElementById('illustrationImage').alt = "Headshot";
                document.getElementById('content').innerHTML = `<p>Next, provide your profile picture. Smiling is optional!</p>`;
                document.getElementById('personalDetails').innerHTML = `
                                                                                                                                                                                                                                                                                            <p><strong>Upload a clear headshot:</strong></p>
                                                                                                                                                                                                                                                                                            <ol style="padding-left: 20px; line-height: 1.6;">
                                                                                                                                                                                                                                                                                                <li>It must be you.</li>
                                                                                                                                                                                                                                                                                                <li>Face the camera directly.</li>
                                                                                                                                                                                                                                                                                                <li>Include head and shoulders.</li>
                                                                                                                                                                                                                                                                                            </ol>
                                                                                                                                                                                                                                                                                            <div style="text-align: center; margin-top: 1rem;">
                                                                                                                                                                                                                                                                                                <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                                                                                                                                                                                                                                                                                                <button type="button" id="uploadButton" class="option-button">Upload Profile Picture</button>
                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                        `;

                // Check if there is a stored profile picture and set it
                const storedProfilePic = localStorage.getItem('profilePic');
                if (storedProfilePic) {
                    document.getElementById('illustrationImage').src = storedProfilePic;
                }

                // Call the function to attach event listeners
                attachUploadEventListeners();
            } else if (currentStage === 4) {
                // Increment to the new stage without updating the sub-progress bar
                currentStage = 5;

                // Change image to proof.jpg and make it non-clickable
                document.getElementById('illustrationImage').src = "../assets/proof.jpg";
                document.getElementById('illustrationImage').alt = "Proof Image";
                document.getElementById('illustrationImage').classList.remove('clickable');

                // Write "Don't Trust Verify" under the image
                document.getElementById('content').innerHTML = "<p style='text-align: center; font-weight: bold;'>Don't Trust Verify</p>";

                // Under that, explain the proof upload instructions
                document.getElementById('personalDetails').innerHTML = `
                                                                                                                                                                                                                <p>
                                                                                                                                                                                                                    Upload proof of your biomarkers: photo or screenshot. This image will be <strong>public</strong>, so you're encouraged to censor any non-relevant information. Make sure to upload an image file (like JPG or PNG) and not a PDF.
                                                                                                                                                                                                                </p>
                                                                                                                                                                                                                <div style="text-align: center; margin-top: 1rem;">
                                                                                                                                                                                                                    <input type="file" id="proofPicInput" accept="image/*" style="display: none;">
                                                                                                                                                                                                                    <button type="button" id="uploadProofButton" class="option-button">Upload Proof</button>
                                                                                                                                                                                                                </div>
                                                                                                                                                                                                            `;

                // Attach event listener to the Upload Proof button
                document.getElementById('uploadProofButton').addEventListener('click', function () {
                    document.getElementById('proofPicInput').click();
                });

                // Handle the image upload (without cropping)
                document.getElementById('proofPicInput').addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Overwrite the proof image data
                            localStorage.setItem('proofPic', e.target.result);

                            // Display the uploaded proof image in the proofImageContainer
                            document.getElementById('proofImageContainer').innerHTML = `
                                                                                                                                                                    <p><strong>Proof image uploaded successfully.</strong></p>
                                                                                                                                                                    <img src="${e.target.result}" alt="Proof Image" style="max-width: 100%; border: 2px solid #333; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);">
                                                                                                                                                                `;

                            // Reset the file input's value to allow re-uploading the same file if needed
                            document.getElementById('proofPicInput').value = "";
                        };
                        reader.readAsDataURL(file); // Read the new file to overwrite the previous one
                    }
                });

            } else if (currentStage === 5) {
                // Increment to the new stage without updating the sub-progress bar
                currentStage = 6;

                document.getElementById('illustrationImage').src = "../assets/finish.jpg";
                document.getElementById('illustrationImage').alt = "Finish Line";
                document.getElementById('content').innerHTML = "<p style='text-align: center; font-weight: bold;'>Final Details</p>";

                // Update the personalDetails with new input fields
                document.getElementById('personalDetails').innerHTML = `
                                                                                                                                                            <!-- Link to Personal Page (Optional) -->
                                                                                                                                                            <label for="personalLink">Link (Optional):</label>
                                                                                                                                                            <input type="url" id="personalLink" name="personalLink" placeholder="https://yourwebsite.com">
                                                                                                                                                            <p style="margin-top: 0.5rem; color: #555;">
                                                                                                                                                                Provide a link to your personal page, social media profile, or any other online presence you wish to advertise.
                                                                                                                                                            </p>

                                                                                                                                                            <!-- Media Contact (Required) -->
                                                                                                                                                            <label for="mediaContact">Media Contact:</label>
                                                                                                                                                            <input type="email" id="mediaContact" name="mediaContact" required aria-required="true" placeholder="media@youremail.com">

                                                                                                                                                            <p style="margin-top: 0.5rem; color: #555;">
                                                                                                                                                                Please provide a media contact email. Be cautious about using your personal email address. It is recommended to create a dedicated email (e.g.: <a href="https://protonmail.com" target="_blank">ProtonMail</a>) or use a social media account like Instagram or Twitter if your messages are open.
                                                                                                                                                            </p>
                                                                                                                                                        `;

            } else if (currentStage === 6) {
                // Increment to the new stage
                currentStage = 7;
                updateSubProgress(5); // Increment the sub progress bar to stage 7

                // Update the heading
                document.querySelector('h2').textContent = "5. Application";

                // Update the illustration image and content
                document.getElementById('illustrationImage').src = "../assets/account-creation.jpg";
                document.getElementById('illustrationImage').alt = "Application";
                document.getElementById('content').innerHTML = "<p>Congrats! All that's left to do is to pride your contact email.</p>";

                // Update the personalDetails with only Email
                document.getElementById('personalDetails').innerHTML = `
                                                                                                <!-- Email Field -->
                                                                                                <label for="accountEmail">Email:</label>
                                                                                                <input type="email" id="accountEmail" name="accountEmail" required aria-required="true" placeholder="yourname@example.com">
                                                                                            `;

                // Change button text to 'Submit' and set type to 'submit' for final submission
                this.textContent = 'Apply';
                this.setAttribute('type', 'submit');
            }
        });

        function attachUploadEventListeners() {
            // Set up event listener for the upload button
            const uploadButton = document.getElementById('uploadButton');
            if (uploadButton && !uploadButton.hasAttribute('data-listener')) {
                uploadButton.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                uploadButton.setAttribute('data-listener', 'true');
            }

            // Add click event to the image to trigger file selection
            const illustrationImage = document.getElementById('illustrationImage');
            if (illustrationImage && !illustrationImage.hasAttribute('data-listener')) {
                illustrationImage.addEventListener('click', function () {
                    document.getElementById('profilePicInput').click();
                });
                illustrationImage.setAttribute('data-listener', 'true');
            }

            // Handle the image upload and initialize Cropper.js
            const profilePicInput = document.getElementById('profilePicInput');
            if (profilePicInput && !profilePicInput.hasAttribute('data-listener')) {
                profilePicInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            // Create an image element for cropping
                            const cropperImage = document.createElement('img');
                            cropperImage.id = 'cropperImage';
                            cropperImage.src = e.target.result;

                            // Clear the current content and insert the image
                            document.getElementById('personalDetails').innerHTML = '';
                            document.getElementById('personalDetails').appendChild(cropperImage);

                            // Initialize Cropper.js on the image
                            const cropper = new Cropper(cropperImage, {
                                aspectRatio: 1024 / 768, // Set the aspect ratio
                                viewMode: 1,
                                autoCropArea: 1,
                                movable: true,
                                zoomable: true,
                                rotatable: false,
                                scalable: false,
                                cropBoxResizable: true,
                                minCropBoxWidth: 200,
                                minCropBoxHeight: 150,
                            });

                            // Add a "Crop and Save" button
                            const cropButton = document.createElement('button');
                            cropButton.textContent = 'Crop and Save';
                            cropButton.className = 'option-button';
                            cropButton.style.marginTop = '1rem';
                            document.getElementById('personalDetails').appendChild(cropButton);

                            // Handle the crop button click
                            cropButton.addEventListener('click', function () {
                                const croppedCanvas = cropper.getCroppedCanvas({
                                    width: 1024,
                                    height: 768,
                                });
                                const croppedImageDataURL = croppedCanvas.toDataURL('image/png');

                                // Set the cropped image as the illustration image
                                document.getElementById('illustrationImage').src = croppedImageDataURL;

                                // Store the cropped image in localStorage
                                localStorage.setItem('profilePic', croppedImageDataURL);

                                // Remove the cropper instance and restore the content
                                cropper.destroy();
                                document.getElementById('personalDetails').innerHTML = `
                                                                                <p><strong>Upload a clear headshot:</strong></p>
                                                                                <ol style="padding-left: 20px; line-height: 1.6;">
                                                                                    <li>It must be you.</li>
                                                                                    <li>Face the camera directly.</li>
                                                                                    <li>Include head and shoulders.</li>
                                                                                </ol>
                                                                                <div style="text-align: center; margin-top: 1rem;">
                                                                                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                                                                                    <button type="button" id="uploadButton" class="option-button">Upload Profile Picture</button>
                                                                                </div>
                                                                            `;
                                // Re-attach event listeners to the new elements
                                attachUploadEventListeners();
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
                profilePicInput.setAttribute('data-listener', 'true');
            }
        }
    </script>
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
</body>
</html>